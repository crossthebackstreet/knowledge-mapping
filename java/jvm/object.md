#### 对象的创建
Java对象创建之前会先检查对象对应的类是否已经被初始化(检查new指令的参数能否在常量池中定位到一个类的符号引用)，如果没有初始化，先对类进行初始化。然后为对象分配内存，对象所需的内存在类加载阶段就已经确定。内存分配方式有两种，一种是指针碰撞（Java堆内存绝对规整，移动指针方式）另外一种是空闲列表（内存空间不规整，维护一张列表，记录哪些内存块是可用的，分配时选取足够大的内存，并修改列表），分配方式由垃圾收集器是否带有压缩整理功能决定。然后将分配到的内存空间初始化为零值（不包括对象头，如果使用TLAB，初始化可以在TLAB分配内存时进行）。设置对象头信息。调用构造器的```<init>```方法，完成实例变量的初始化。

*为了保证对象创建时线程安全，虚拟机采用CAS失败重试的方式创建对象。还有一种方式是每个线程在堆内存中预先分配一块内存，这块内存称为TLAB（Thread Local Allocation Buffer，本地线程分配缓冲），线程分配内存时在TLAB上分配。*

#### 对象内存布局
对象可分为三个部分：对象头、实例数据、对齐填充。
对象头分为两部分，一部分保存对象自身的数据，如哈希码、GC分代年龄、锁状态标志、对象持有的锁、偏向线程ID、偏向时间戳等，这部分内容称为```Mark Word```，```Mark Word```在32位系统和64位系统中分别占用的内存空间大小为32位、64位（未开启指针压缩）。对象头的另一部分是类型指针，虚拟机通过这个指针确定这个对象是哪个类的实例。对象头在64位系统中开启指针压缩和不开启指针压缩占用的内存分别为12字节和16字节<sup>[1]</sup>，
实例数据部分保存了类中定义的实例数据，包括从父类中继承的。
对齐填充是非必须的，HotSpot虚拟机中要求对象占用空间的大小必须是8的整数倍。

#### 对象的访问定位
对象访问定位就是如何通过reference定位到对象，定位方式有两种，一种是使用句柄，一种是直接指针。

使用句柄方式访问，需要在Java堆中分配一块内存作为句柄池，句柄中保存了对象实例数据和对象类型数据的地址，reference保存了句柄地址。  
![use handle]  
直接指针方式访问，reference直接保存了对象的地址。  
![direct pointer]  
使用句柄方式的好处是如果对象地址发生改变，只需修改句柄中对象实例数据指针即可。
直接指针方式的好处是访问速度快，因为它指针定位次数少。

**HotSpot使用直接指针方式定位对象。**

[1]. [如何分析对象占用的内存大小?](https://segmentfault.com/a/1190000006933272)

[use handle]: <../../_assets/use-handle.png>
[direct pointer]: <../../_assets/direct-pointer.png>